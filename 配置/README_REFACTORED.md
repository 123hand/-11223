# 多模态面试评测智能体 - 重构版本

## 项目概述

这是一个基于讯飞AI能力平台的多模态面试评测智能体系统，经过重构后具有更好的可维护性、稳定性和扩展性。

## 重构亮点

### 1. 架构优化
- **模块化设计**：将音频处理、错误处理、健康监控等功能分离为独立模块
- **状态管理**：使用枚举类型管理面试状态，提高代码可读性
- **配置管理**：统一的配置管理，支持运行时配置调整

### 2. 音频处理重构
- **AudioProcessor类**：专门处理音频采集和处理逻辑
- **优化线程管理**：改进音频采集线程的稳定性和错误处理
- **VAD优化**：改进语音活动检测的准确性

### 3. 错误处理增强
- **ErrorHandler类**：统一的错误处理和恢复机制
- **ComponentHealthMonitor类**：实时监控组件健康状态
- **自动恢复**：支持组件故障自动恢复

### 4. 代码质量提升
- **类型注解**：添加完整的类型提示
- **异常处理**：改进异常处理机制
- **日志优化**：更详细的日志记录

## 项目结构

```
├── app_refactored.py          # 主程序（重构版本）
├── config.py                  # 配置文件
├── error_handler.py           # 错误处理模块
├── xfyun_asr_client.py        # 讯飞ASR客户端
├── xfyun_tts_client.py        # 讯飞TTS客户端
├── xfyun_spark_client.py      # 讯飞Spark客户端
├── voice_analyzer.py          # 语音分析模块
├── video_processor.py         # 视频处理模块
├── requirements.txt           # 依赖包列表
└── README_REFACTORED.md       # 本文档
```

## 核心组件

### 1. InterviewSession
面试会话管理类，负责：
- 面试流程控制
- 组件初始化和管理
- 状态转换
- 资源清理

### 2. AudioProcessor
音频处理器，负责：
- 音频采集
- VAD检测
- ASR音频发送
- 音频资源管理

### 3. ErrorHandler
错误处理器，提供：
- 统一错误处理
- 自动恢复机制
- 错误统计和报告

### 4. ComponentHealthMonitor
健康监控器，提供：
- 组件健康检查
- 实时监控
- 故障检测

## 配置说明

### 面试配置
```python
INTERVIEW_TOTAL_QUESTIONS = 3      # 面试问题总数
ASR_MAX_FAILURES = 2               # ASR连续失败最大次数
ASR_TIMEOUT = 15.0                 # ASR超时时间
TTS_WAIT_TIMEOUT = 10.0            # TTS等待超时时间
```

### 音频配置
```python
AUDIO_BUFFER_SIZE = 1000           # 音频缓冲区大小
AUDIO_FRAME_SIZE = 1280            # 音频帧大小
AUDIO_SEND_INTERVAL = 0.04         # 音频发送间隔
AUDIO_MAX_CONSECUTIVE_ERRORS = 5   # 最大连续错误次数
```

### 错误处理配置
```python
ENABLE_AUTO_RECOVERY = True        # 启用自动恢复
RECOVERY_MAX_ATTEMPTS = 3          # 最大恢复尝试次数
RECOVERY_INTERVAL = 2.0            # 恢复间隔
```

## 使用方法

### 1. 环境准备
```bash
# 安装依赖
pip install -r requirements.txt

# 配置API密钥
# 编辑 config.py 文件，填入您的讯飞API密钥
```

### 2. 运行程序
```bash
python app_refactored.py
```

### 3. 面试流程
1. 系统初始化所有组件
2. 面试官打招呼
3. 用户进行自我介绍
4. 系统提出3个面试问题
5. 用户回答每个问题
6. 面试结束，系统总结

## 错误处理机制

### 1. 自动恢复
- 当组件发生故障时，系统会自动尝试恢复
- 支持ASR、TTS、Spark、音频处理器等组件的自动恢复
- 可配置最大恢复尝试次数

### 2. 健康监控
- 实时监控各组件健康状态
- 定期进行健康检查
- 发现异常时自动触发恢复机制

### 3. 兜底机制
- ASR识别失败时使用默认回答
- 超时自动推进面试流程
- 确保面试流程的完整性

## 性能优化

### 1. 音频处理优化
- 使用非阻塞队列避免音频数据丢失
- 优化VAD检测阈值
- 改进音频帧发送策略

### 2. 线程管理优化
- 使用守护线程避免资源泄漏
- 改进线程同步机制
- 优化线程健康检查

### 3. 内存管理优化
- 及时清理音频缓冲区
- 优化对象生命周期管理
- 减少内存泄漏风险

## 扩展性

### 1. 模块化设计
- 各功能模块独立，便于扩展
- 支持插件式架构
- 易于添加新功能

### 2. 配置驱动
- 通过配置文件控制行为
- 支持运行时配置调整
- 便于部署和调试

### 3. 接口标准化
- 统一的组件接口
- 标准化的错误处理
- 便于集成新组件

## 故障排除

### 1. 常见问题
- **音频设备问题**：检查麦克风设置和权限
- **网络连接问题**：检查讯飞API网络连接
- **API密钥问题**：验证API密钥配置

### 2. 调试方法
- 查看详细日志输出
- 检查组件健康状态
- 使用配置调整参数

### 3. 性能调优
- 调整音频缓冲区大小
- 优化VAD阈值
- 调整超时时间

## 版本历史

### v2.0 (重构版本)
- 重构主流程和采集线程
- 添加错误处理和恢复机制
- 改进配置管理
- 优化代码结构和可维护性

### v1.0 (原始版本)
- 基础功能实现
- 简单的错误处理
- 基本配置管理

## 贡献指南

欢迎提交Issue和Pull Request来改进项目。请确保：
- 代码符合PEP 8规范
- 添加适当的类型注解
- 更新相关文档
- 通过所有测试

## 许可证

本项目采用MIT许可证，详见LICENSE文件。 